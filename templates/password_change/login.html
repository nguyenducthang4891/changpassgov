<!DOCTYPE html>
{% load static %}
<html lang="vi">
<head>
    <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="ƒêƒÉng nh·∫≠p h·ªá th·ªëng">

    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <title>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</title>

    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/bootstrap-icons.css' %}" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #d2f1fd 0%, #5fcfff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            max-width: 450px;
            width: 100%;
        }

        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #0663c5 100%);
            padding: 20px 20px;
            text-align: center;
            color: white;
        }

        .login-header i {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .login-body {
            padding: 40px 30px;
        }

        .form-control {
            border-radius: 10px;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .input-group-text {
            background: white;
            border: 2px solid #e0e0e0;
            border-right: none;
            border-radius: 10px 0 0 10px;
        }

        .input-group .form-control {
            border-left: none;
            border-radius: 0 10px 10px 0;
        }

        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #0663c5 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-login:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .text-danger.small {
            margin-top: 0.25rem;
            display: block;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="login-card mx-auto">
        <div class="login-header">
            <i class="bi bi-shield-lock-fill"></i>
            <h2 class="mb-0">ƒêƒÉng nh·∫≠p</h2>
            <p class="mb-0 mt-2 opacity-75">Nh·∫≠p th√¥ng tin ƒë·ªÉ ti·∫øp t·ª•c</p>
        </div>

        <div class="login-body">
            <!-- Alert th√¥ng b√°o -->
            <div id="alertContainer">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <form method="post" id="loginForm" novalidate>
                {% csrf_token %}

                <div class="mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label">
                        {{ form.email.label }}
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-envelope-fill text-secondary"></i>
                        </span>
                        {{ form.email }}
                    </div>
                    <div id="emailError" class="text-danger small"></div>
                    {% if form.email.errors %}
                        <div class="text-danger small">{{ form.email.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.password.id_for_label }}" class="form-label">
                        {{ form.password.label }}
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-lock-fill text-secondary"></i>
                        </span>
                        {{ form.password }}
                    </div>
                    <div id="passwordError" class="text-danger small"></div>
                    {% if form.password.errors %}
                        <div class="text-danger small">{{ form.password.errors.0 }}</div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary btn-login w-100" id="loginBtn">
                    <span id="btnText">ƒêƒÉng nh·∫≠p</span>
                    <span id="btnSpinner" class="d-none">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        ƒêang x·ª≠ l√Ω...
                    </span>
                </button>
            </form>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <small class="text-muted">
                    <a href="{% url 'app:change_password' %}" class="text-decoration-none">
                        <i class="bi bi-key-fill me-1"></i>Thay ƒë·ªïi m·∫≠t kh·∫©u
                    </a>
                </small>

                <small class="text-muted">
                    <a href="#" class="text-decoration-none text-danger">
                        <i class="bi bi-question-circle-fill me-1"></i>Qu√™n m·∫≠t kh·∫©u?
                    </a>
                </small>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("loginForm");
    const btn = document.getElementById("loginBtn");
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");
    const alertContainer = document.getElementById("alertContainer");
    const emailError = document.getElementById("emailError");
    const passwordError = document.getElementById("passwordError");

    form.addEventListener("submit", async function(e) {
        e.preventDefault();

        // Clear previous errors
        emailError.textContent = "";
        passwordError.textContent = "";
        alertContainer.innerHTML = "";

        // Show loading state
        btn.disabled = true;
        btnText.classList.add("d-none");
        btnSpinner.classList.remove("d-none");

        const formData = new FormData(form);
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        try {
            const response = await fetch("", {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": csrfToken
                }
            });

            const data = await response.json();

            if (data.success) {
                // üîí Redirect ƒë·∫øn intermediate page
                // URL n√†y KH√îNG ch·ª©a zm_auth_token
                window.location.href = data.redirect_url;
            } else {
                // Reset button state
                btn.disabled = false;
                btnText.classList.remove("d-none");
                btnSpinner.classList.add("d-none");

                // Show error message
                if (data.message) {
                    const alertDiv = document.createElement("div");
                    alertDiv.className = "alert alert-danger alert-dismissible fade show";
                    alertDiv.role = "alert";
                    alertDiv.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    alertContainer.appendChild(alertDiv);
                }

                // Show field errors
                if (data.errors) {
                    if (data.errors.email) {
                        emailError.textContent = data.errors.email;
                    }
                    if (data.errors.password) {
                        passwordError.textContent = data.errors.password;
                    }
                }
            }
        } catch (error) {
            // Reset button state
            btn.disabled = false;
            btnText.classList.remove("d-none");
            btnSpinner.classList.add("d-none");

            // Show network error
            const alertDiv = document.createElement("div");
            alertDiv.className = "alert alert-danger alert-dismissible fade show";
            alertDiv.role = "alert";
            alertDiv.innerHTML = `
                Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alertDiv);

            console.error("Login error:", error);
        }
    });
});
</script>

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>